<!DOCTYPE html>
<html>
<head>
    <title>OKGO + Twilio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon_57.png"/>
    <link rel="apple-touch-icon" href="/favicon_57.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="/favicon_72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="/favicon_114.png"/>
    <link rel="stylesheet" href="/bell.css">
    <!--<link rel="stylesheet" href="/bell.css">-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="socket.io.slim.js"></script>
        
</head>
<script>
    var socket = io();
    socket.on('connect', () => {
        styleConnected();
    })

    socket.on('disconnect', (reason) => {
      if (reason === 'io server disconnect') {
        // the disconnection was initiated by the server, you need to reconnect manually
        socket.connect();
      }
      styleConnected()
    });

    var selectedNote = "-1";
    let lastX, lastY, lastZ, lastDelta;
    let blocked = false;        // i have no idea what the intent of this is.
    var debounceTime = 400;    // 600 ms seemed too short.  i was getting double events.
    let primed = true;
    let down = false;
    let up = false;
    let timer = '';
    let resting = false;
    let restStart, restElapsed;
    // const movement = {
    //     primed: [-12, -3],
    //     down: [3, 13],
    //     up: [-100, -30],
    //     rest: [-2, 2]
    // }
    const movement = {
        primed: [4, 10],
        down: [-1000, -10],
        up: [4, 20],
        rest: [-3, 3]
    }

    function emitNote () {
        socket.emit('note', selectedNote);
        console.timeEnd(timer);
    }

    function handleMotion (e) {
        let acc = e.acceleration;
        if (!acc.hasOwnProperty('x')) {

            acc = e.accelerationIncludingGravity;
        }

        if (!down) {
            down = acc.x <= movement.down[1];
            if (down) console.log(`Down------------------------: ${acc.x}`)
        }

        if (down && !up) {
            up = acc.x >= movement.up[0];
            if (up) {
                console.log(`Up ------------------------: ${acc.x}`)
                timer = ""+acc.x;
                console.time(timer)
                sendNote();
                down = up = false;
            } 
        }

        if (!resting) {
            resting = acc.x >= movement.rest[0] && acc.x <= movement.rest[1];
            if (resting) {restStart = (new Date()).getTime()}
        } else {
            resting = acc.x >= movement.rest[0] && acc.x <= movement.rest[1];
            if (resting) {restElapsed = (new Date()).getTime() - restStart}
        }

        if (restElapsed > 600) {
            console.log('Resetting '+ restElapsed)
            down = up = resting = false;
            restElapsed = 0;
            return
        }
    }

    function sendNote () {
        if (!blocked) {
            emitNote();
            blocked = true;
            console.log("PLAY NOTE ---------------------- ##################### ")
            setTimeout(function () {
                blocked = false;
            }, debounceTime)
        }
    }

    function styleConnected () {
        if (window.jQuery) {
            if (socket.connected) {
                $('.action').addClass('live');
            }
            if (socket.disconnected) {
                $('.action').removeClass('live');
            }
        } else {
            setTimeout(styleConnected, 2000);
        }
    }

    $(document).ready(function () {

        window.addEventListener("devicemotion", handleMotion, true);
        // window.addEventListener("MozOrientation", handleMotion, true);
        // window.addEventListener("deviceorientation", handleMotion, true);

        var savedNote = localStorage.getItem("note");
        let noteAbbr;

        if (savedNote) {
            selectedNote = savedNote;
            noteAbbr = selectedNote.length >= 3 ? `${selectedNote[0]}${selectedNote[1]}` : selectedNote[0];
            $(".action").addClass(noteAbbr);
            $("#note").html(selectedNote);
            $('#whichnote').val(selectedNote);
        }

        $("#whichnote").change(function () {
            var which = $("#whichnote option:selected");
            if (which.val() !== "-1") {
                selectedNote = which.val();
                noteAbbr = selectedNote.length >= 3 ? `${selectedNote[0]}${selectedNote[1]}` : selectedNote[0];
                $("#note").html(selectedNote);
                localStorage.setItem("note", selectedNote);
            }
        });

        if (socket.connected) {
            $('.action').addClass('live');
        }
    });
</script>

<body class="vbox viewport">
    <div class="action">
        <select id="whichnote">
            <option value="A#2">A#2</option>
            <option value="A#3">A#3</option>
            <option value="A0">A0</option>
            <option value="A2">A2</option>
            <option value="A3">A3</option>
            <option value="A4">A4</option>
            <option value="Ab2">Ab2</option>
            <option value="Ab3">Ab3</option>
            <option value="Ab4">Ab4</option>
            <option value="B2">B2</option>
            <option value="B3">B3</option>
            <option value="B4">B4</option>
            <option value="Bb4">Bb4</option>
            <option value="C2">C2</option>
            <option value="C3">C3</option>
            <option value="C4">C4</option>
            <option value="C5">C5</option>
            <option value="D2">D2</option>
            <option value="D3">D3</option>
            <option value="D4">D4</option>
            <option value="D5">D5</option>
            <option value="Db2">Db2</option>
            <option value="Db3">Db3</option>
            <option value="Db4">Db4</option>
            <option value="Db5">Db5</option>
            <option value="E2">E2</option>
            <option value="E3">E3</option>
            <option value="E4">E4</option>
            <option value="E5">E5</option>
            <option value="E54">E54</option>
            <option value="Eb2">Eb2</option>
            <option value="Eb3">Eb3</option>
            <option value="Eb4">Eb4</option>
            <option value="Eb5">Eb5</option>
            <option value="F2">F2</option>
            <option value="F3">F3</option>
            <option value="F4">F4</option>
            <option value="F5">F5</option>
            <option value="G2">G2</option>
            <option value="G3">G3</option>
            <option value="G4">G4</option>
            <option value="Gb2">Gb2</option>
            <option value="Gb3">Gb3</option>
            <option value="Gb4">Gb4</option>
            <option value="Gb5">Gb5</option>
            <option value="-1" selected="selected">Select a Note</option>
        </select>
        <h1 id="note"></h1>
    </div>
    <div class="accent"></div>
<div id="music">
    #    <!--<span id="rotateText">#</span>-->
</div>

</body>
</html>